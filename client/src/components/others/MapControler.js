import { LayersControl, ZoomControl, useMap } from "react-leaflet";
import React, { useEffect, useContext, useState } from "react";

// import components
import MainMenuControl from "./MainMenuControl";
import PolygonLayer from "../layers/PolygonLayer";
import PointsLayer from "../layers/PointsLayer";
import BaseLayers from "../layers/BaseLayers";
import PanelTabs from "./PanelTabs";
import MapLegend from "./MapLegend";
import SearchField from "./GeoSearchBox";
// import GeoJsonLayer from "./vectorTiles/GeoJsonLayerRiverNetwork";
import VectorGrid from "./vectorTiles/VectorGrid";
import VectorGridLegend from "./vectorTiles/VectorGridLegend";
import TimeViewer from "./vectorTiles/TimeViewer";
import { Button } from "react-bootstrap";
import ContourPolygon from "./vectorTiles/ContourPolygons";

import "leaflet/dist/leaflet.css";
import "../../App.css";

// import SideNavBarMap from "./SideNavBar/SideNavBarMap";

// import contexts
import ConsCache from "../contexts/ConsCache";
import ConsFixed from "../contexts/ConsFixed";
import consFixedLib from "../contexts/consFixedLib";
import VarsState from "../contexts/VarsState";
import varsStateLib from "../contexts/varsStateLib";

// import assets
import { baseLayersData } from "../../assets/MapBaseLayers";

const MapControler = ({ settings }) => {
  // this specific component is needed to allow useMap()
  const map = useMap();

  // load contexts
  const { consCache } = useContext(ConsCache);
  const { consFixed } = useContext(ConsFixed);
  const { varsState, setVarState } = useContext(VarsState);

  // when varsState.context is changed, update location icons
  useEffect(() => {
    varsStateLib.updateLocationIcons(varsState, consCache, consFixed, settings);
    setVarState(Math.random());
  }, [varsState.context, varsStateLib.getMainMenuControlActiveTab(varsState)]);

  // when varsState.context is changed, update map view window
  useEffect(() => {
    let mapExtent = null;

    if (varsStateLib.inMainMenuControlActiveTabOverview(varsState)) {
      mapExtent = consFixedLib.getRegionData(consFixed).map.defaultExtent;
    } else if (varsStateLib.inMainMenuControlActiveTabFilters(varsState)) {
      const filterId = varsStateLib.getContextFilterId(varsState);
      const filterData = consFixedLib.getFilterData(filterId, consFixed);

      // basic check
      if (!filterData) {
        return;
      }

      //
      mapExtent = filterData.map.defaultExtent;
    } else {
      return null;
    }

    const mapBounds = [
      [mapExtent.bottom, mapExtent.left],
      [mapExtent.top, mapExtent.right],
    ];

    map.fitBounds(mapBounds);
  }, [
    varsState.context,
    varsStateLib.getContextFilterId(varsState),
    varsStateLib.getMainMenuControlActiveTab(varsState),
  ]);

  const baseUrl =
    "http://192.168.100.123:8082/resultados_simulacion/date/{z}/{x}/{y}.pbf";

  const [url, setUrl] = useState(
    "http://192.168.100.123:8082/resultados_simulacion/20220328000000/{z}/{x}/{y}.pbf"
  );

  const urls = [
    "20220328000000",
    "20220328020000",
    "20220328040000",
    "20220328060000",
    "20220328080000",
    "20220328100000",
    "20220328120000",
    "20220328140000",
    "20220328160000",
    "20220328180000",
    "20220328200000",
    "20220328220000",
    "20220329000000",
    "20220329020000",
    "20220329040000",
    "20220329060000",
    "20220329080000",
    "20220329100000",
    "20220329120000",
    "20220329140000",
    "20220329160000",
    "20220329180000",
    "20220329200000",
    "20220329220000",
    "20220330000000",
    "20220330020000",
    "20220330040000",
    "20220330060000",
    "20220330080000",
    "20220330100000",
    "20220330120000",
    "20220330140000",
    "20220330160000",
    "20220330180000",
    "20220330200000",
    "20220330220000",
    "20220331000000",
    "20220331020000",
    "20220331040000",
    "20220331060000",
    "20220331080000",
    "20220331100000",
    "20220331120000",
    "20220331140000",
    "20220331160000",
    "20220331180000",
    "20220331200000",
    "20220331220000",
    "20220401000000",
    "20220401020000",
    "20220401040000",
    "20220401060000",
    "20220401080000",
    "20220401100000",
    "20220401120000",
    "20220401140000",
    "20220401160000",
    "20220401180000",
    "20220401200000",
    "20220401220000",
    "20220402000000",
    "20220402020000",
    "20220402040000",
    "20220402060000",
    "20220402080000",
    "20220402100000",
    "20220402120000",
    "20220402140000",
    "20220402160000",
    "20220402180000",
    "20220402200000",
    "20220402220000",
    "20220403000000",
    "20220403020000",
    "20220403040000",
    "20220403060000",
    "20220403080000",
    "20220403100000",
    "20220403120000",
    "20220403140000",
    "20220403160000",
    "20220403180000",
    "20220403200000",
    "20220403220000",
    "20220404000000",
    "20220404020000",
    "20220404040000",
    "20220404060000",
    "20220404080000",
    "20220404100000",
    "20220404120000",
    "20220404140000",
    "20220404160000",
    "20220404180000",
    "20220404200000",
    "20220404220000",
    "20220405000000",
    "20220405020000",
    "20220405040000",
    "20220405060000",
    "20220405080000",
    "20220405100000",
    "20220405120000",
    "20220405140000",
    "20220405160000",
    "20220405180000",
    "20220405200000",
    "20220405220000",
    "20220406000000",
    "20220406020000",
    "20220406040000",
    "20220406060000",
    "20220406080000",
    "20220406100000",
    "20220406120000",
    "20220406140000",
    "20220406160000",
    "20220406180000",
    "20220406200000",
    "20220406220000",
    "20220407000000",
    "20220407020000",
    "20220407040000",
    "20220407060000",
    "20220407080000",
    "20220407100000",
    "20220407120000",
    "20220407140000",
    "20220407160000",
    "20220407180000",
    "20220407200000",
    "20220407220000",
    "20220408000000",
    "20220408020000",
    "20220408040000",
    "20220408060000",
    "20220408080000",
    "20220408100000",
    "20220408120000",
    "20220408140000",
    "20220408160000",
    "20220408180000",
    "20220408200000",
    "20220408220000",
    "20220409000000",
    "20220409020000",
    "20220409040000",
    "20220409060000",
    "20220409080000",
    "20220409100000",
    "20220409120000",
    "20220409140000",
    "20220409160000",
    "20220409180000",
    "20220409200000",
    "20220409220000",
    "20220410000000",
    "20220410020000",
    "20220410040000",
    "20220410060000",
    "20220410080000",
    "20220410100000",
    "20220410120000",
    "20220410140000",
    "20220410160000",
    "20220410180000",
    "20220410200000",
    "20220410220000",
    "20220411000000",
    "20220411020000",
    "20220411040000",
    "20220411060000",
    "20220411080000",
    "20220411100000",
    "20220411120000",
    "20220411140000",
    "20220411160000",
    "20220411180000",
    "20220411200000",
    "20220411220000",
    "20220412000000",
    "20220412020000",
    "20220412040000",
    "20220412060000",
    "20220412080000",
    "20220412100000",
    "20220412120000",
    "20220412140000",
    "20220412160000",
    "20220412180000",
    "20220412200000",
    "20220412220000",
    "20220413000000",
    "20220413020000",
    "20220413040000",
    "20220413060000",
    "20220413080000",
    "20220413100000",
    "20220413120000",
    "20220413140000",
    "20220413160000",
    "20220413180000",
    "20220413200000",
    "20220413220000",
    "20220414000000",
    "20220414020000",
    "20220414040000",
    "20220414060000",
    "20220414080000",
    "20220414100000",
    "20220414120000",
    "20220414140000",
    "20220414160000",
    "20220414180000",
    "20220414200000",
    "20220414220000",
    "20220415000000",
    "20220415020000",
    "20220415040000",
    "20220415060000",
    "20220415080000",
    "20220415100000",
    "20220415120000",
    "20220415140000",
    "20220415160000",
    "20220415180000",
    "20220415200000",
    "20220415220000",
    "20220416000000",
    "20220416020000",
    "20220416040000",
    "20220416060000",
    "20220416080000",
    "20220416100000",
    "20220416120000",
    "20220416140000",
    "20220416160000",
    "20220416180000",
    "20220416200000",
    "20220416220000",
    "20220417000000",
    "20220417020000",
    "20220417040000",
    "20220417060000",
    "20220417080000",
    "20220417100000",
    "20220417120000",
    "20220417140000",
    "20220417160000",
    "20220417180000",
    "20220417200000",
    "20220417220000",
    "20220418000000",
    "20220418020000",
    "20220418040000",
    "20220418060000",
    "20220418080000",
    "20220418100000",
    "20220418120000",
    "20220418140000",
    "20220418160000",
    "20220418180000",
    "20220418200000",
    "20220418220000",
    "20220419000000",
    "20220419020000",
    "20220419040000",
    "20220419060000",
    "20220419080000",
    "20220419100000",
    "20220419120000",
    "20220419140000",
    "20220419160000",
    "20220419180000",
    "20220419200000",
    "20220419220000",
    "20220420000000",
    "20220420020000",
    "20220420040000",
    "20220420060000",
    "20220420080000",
    "20220420100000",
    "20220420120000",
    "20220420140000",
    "20220420160000",
    "20220420180000",
    "20220420200000",
    "20220420220000",
    "20220421000000",
    "20220421020000",
    "20220421040000",
    "20220421060000",
    "20220421080000",
    "20220421100000",
    "20220421120000",
    "20220421140000",
    "20220421160000",
    "20220421180000",
    "20220421200000",
    "20220421220000",
    "20220422000000",
    "20220422020000",
    "20220422040000",
    "20220422060000",
    "20220422080000",
    "20220422100000",
    "20220422120000",
    "20220422140000",
    "20220422160000",
    "20220422180000",
    "20220422200000",
    "20220422220000",
    "20220423000000",
    "20220423020000",
    "20220423040000",
    "20220423060000",
    "20220423080000",
    "20220423100000",
    "20220423120000",
    "20220423140000",
    "20220423160000",
    "20220423180000",
    "20220423200000",
    "20220423220000",
    "20220424000000",
    "20220424020000",
    "20220424040000",
    "20220424060000",
    "20220424080000",
    "20220424100000",
    "20220424120000",
    "20220424140000",
    "20220424160000",
    "20220424180000",
    "20220424200000",
    "20220424220000",
    "20220425000000",
    "20220425020000",
    "20220425040000",
    "20220425060000",
    "20220425080000",
    "20220425100000",
    "20220425120000",
    "20220425140000",
    "20220425160000",
    "20220425180000",
    "20220425200000",
    "20220425220000",
    "20220426000000",
    "20220426020000",
    "20220426040000",
    "20220426060000",
    "20220426080000",
    "20220426100000",
    "20220426120000",
    "20220426140000",
    "20220426160000",
    "20220426180000",
    "20220426200000",
    "20220426220000",
    "20220427000000",
    "20220427020000",
    "20220427040000",
    "20220427060000",
    "20220427080000",
    "20220427100000",
    "20220427120000",
    "20220427140000",
    "20220427160000",
    "20220427180000",
    "20220427200000",
    "20220427220000",
    "20220428000000",
    "20220428020000",
    "20220428040000",
    "20220428060000",
    "20220428080000",
    "20220428100000",
    "20220428120000",
    "20220428140000",
    "20220428160000",
    "20220428180000",
    "20220428200000",
    "20220428220000",
    "20220429000000",
    "20220429020000",
    "20220429040000",
    "20220429060000",
    "20220429080000",
    "20220429100000",
    "20220429120000",
    "20220429140000",
    "20220429160000",
    "20220429180000",
    "20220429200000",
    "20220429220000",
    "20220430000000",
    "20220430020000",
    "20220430040000",
    "20220430060000",
    "20220430080000",
    "20220430100000",
    "20220430120000",
    "20220430140000",
    "20220430160000",
    "20220430180000",
    "20220430200000",
    "20220430220000",
    "20220501000000",
    "20220501020000",
    "20220501040000",
    "20220501060000",
    "20220501080000",
    "20220501100000",
    "20220501120000",
    "20220501140000",
    "20220501160000",
    "20220501180000",
    "20220501200000",
    "20220501220000",
    "20220502000000",
    "20220502020000",
    "20220502040000",
    "20220502060000",
    "20220502080000",
    "20220502100000",
    "20220502120000",
    "20220502140000",
    "20220502160000",
    "20220502180000",
    "20220502200000",
    "20220502220000",
    "20220503000000",
    "20220503020000",
    "20220503040000",
    "20220503060000",
    "20220503080000",
    "20220503100000",
    "20220503120000",
    "20220503140000",
    "20220503160000",
    "20220503180000",
    "20220503200000",
    "20220503220000",
    "20220504000000",
    "20220504020000",
    "20220504040000",
    "20220504060000",
    "20220504080000",
    "20220504100000",
    "20220504120000",
    "20220504140000",
    "20220504160000",
    "20220504180000",
    "20220504200000",
    "20220504220000",
    "20220505000000",
    "20220505020000",
    "20220505040000",
    "20220505060000",
    "20220505080000",
    "20220505100000",
    "20220505120000",
    "20220505140000",
    "20220505160000",
    "20220505180000",
    "20220505200000",
    "20220505220000",
    "20220506000000",
    "20220506020000",
    "20220506040000",
    "20220506060000",
    "20220506080000",
    "20220506100000",
    "20220506120000",
    "20220506140000",
    "20220506160000",
    "20220506180000",
    "20220506200000",
    "20220506220000",
    "20220507000000",
    "20220507020000",
    "20220507040000",
    "20220507060000",
    "20220507080000",
    "20220507100000",
    "20220507120000",
    "20220507140000",
    "20220507160000",
    "20220507180000",
    "20220507200000",
    "20220507220000",
    "20220508000000",
    "20220508020000",
    "20220508040000",
    "20220508060000",
    "20220508080000",
    "20220508100000",
    "20220508120000",
    "20220508140000",
    "20220508160000",
    "20220508180000",
    "20220508200000",
    "20220508220000",
    "20220509000000",
    "20220509020000",
    "20220509040000",
    "20220509060000",
    "20220509080000",
    "20220509100000",
    "20220509120000",
    "20220509140000",
    "20220509160000",
    "20220509180000",
    "20220509200000",
    "20220509220000",
    "20220510000000",
    "20220510020000",
    "20220510040000",
    "20220510060000",
    "20220510080000",
    "20220510100000",
    "20220510120000",
    "20220510140000",
    "20220510160000",
    "20220510180000",
    "20220510200000",
    "20220510220000",
    "20220511000000",
    "20220511020000",
    "20220511040000",
    "20220511060000",
    "20220511080000",
    "20220511100000",
    "20220511120000",
    "20220511140000",
    "20220511160000",
    "20220511180000",
    "20220511200000",
    "20220511220000",
    "20220512000000",
    "20220512020000",
    "20220512040000",
    "20220512060000",
    "20220512080000",
    "20220512100000",
    "20220512120000",
    "20220512140000",
    "20220512160000",
    "20220512180000",
    "20220512200000",
    "20220512220000",
    "20220513000000",
    "20220513020000",
    "20220513040000",
    "20220513060000",
    "20220513080000",
    "20220513100000",
    "20220513120000",
    "20220513140000",
    "20220513160000",
    "20220513180000",
    "20220513200000",
    "20220513220000",
    "20220514000000",
    "20220514020000",
    "20220514040000",
    "20220514060000",
    "20220514080000",
    "20220514100000",
    "20220514120000",
    "20220514140000",
    "20220514160000",
    "20220514180000",
    "20220514200000",
    "20220514220000",
    "20220515000000",
    "20220515020000",
    "20220515040000",
    "20220515060000",
    "20220515080000",
    "20220515100000",
    "20220515120000",
    "20220515140000",
    "20220515160000",
    "20220515180000",
    "20220515200000",
    "20220515220000",
    "20220516000000",
    "20220516020000",
    "20220516040000",
    "20220516060000",
    "20220516080000",
    "20220516100000",
    "20220516120000",
    "20220516140000",
    "20220516160000",
    "20220516180000",
    "20220516200000",
    "20220516220000",
    "20220517000000",
    "20220517020000",
    "20220517040000",
    "20220517060000",
    "20220517080000",
    "20220517100000",
    "20220517120000",
    "20220517140000",
    "20220517160000",
    "20220517180000",
    "20220517200000",
    "20220517220000",
    "20220518000000",
    "20220518020000",
    "20220518040000",
    "20220518060000",
    "20220518080000",
    "20220518100000",
    "20220518120000",
    "20220518140000",
    "20220518160000",
    "20220518180000",
    "20220518200000",
    "20220518220000",
    "20220519000000",
    "20220519020000",
    "20220519040000",
    "20220519060000",
    "20220519080000",
    "20220519100000",
    "20220519120000",
    "20220519140000",
    "20220519160000",
    "20220519180000",
    "20220519200000",
    "20220519220000",
    "20220520000000",
    "20220520020000",
    "20220520040000",
    "20220520060000",
    "20220520080000",
    "20220520100000",
    "20220520120000",
    "20220520140000",
    "20220520160000",
    "20220520180000",
    "20220520200000",
    "20220520220000",
    "20220521000000",
    "20220521020000",
    "20220521040000",
    "20220521060000",
    "20220521080000",
    "20220521100000",
    "20220521120000",
    "20220521140000",
    "20220521160000",
    "20220521180000",
    "20220521200000",
    "20220521220000",
    "20220522000000",
    "20220522020000",
    "20220522040000",
    "20220522060000",
    "20220522080000",
    "20220522100000",
    "20220522120000",
    "20220522140000",
    "20220522160000",
    "20220522180000",
    "20220522200000",
    "20220522220000",
    "20220523000000",
    "20220523020000",
    "20220523040000",
    "20220523060000",
    "20220523080000",
    "20220523100000",
    "20220523120000",
    "20220523140000",
    "20220523160000",
    "20220523180000",
    "20220523200000",
    "20220523220000",
    "20220524000000",
    "20220524020000",
    "20220524040000",
    "20220524060000",
    "20220524080000",
    "20220524100000",
    "20220524120000",
    "20220524140000",
    "20220524160000",
    "20220524180000",
    "20220524200000",
    "20220524220000",
    "20220525000000",
    "20220525020000",
    "20220525040000",
    "20220525060000",
    "20220525080000",
    "20220525100000",
    "20220525120000",
    "20220525140000",
    "20220525160000",
    "20220525180000",
    "20220525200000",
    "20220525220000",
    "20220526000000",
    "20220526020000",
    "20220526040000",
    "20220526060000",
    "20220526080000",
    "20220526100000",
    "20220526120000",
    "20220526140000",
    "20220526160000",
    "20220526180000",
    "20220526200000",
    "20220526220000",
    "20220527000000",
    "20220527020000",
    "20220527040000",
    "20220527060000",
    "20220527080000",
    "20220527100000",
    "20220527120000",
    "20220527140000",
    "20220527160000",
    "20220527180000",
    "20220527200000",
    "20220527220000",
    "20220528000000",
    "20220528020000",
    "20220528040000",
    "20220528060000",
    "20220528080000",
    "20220528100000",
    "20220528120000",
    "20220528140000",
    "20220528160000",
    "20220528180000",
    "20220528200000",
    "20220528220000",
    "20220529000000",
    "20220529020000",
    "20220529040000",
    "20220529060000",
    "20220529080000",
    "20220529100000",
    "20220529120000",
    "20220529140000",
    "20220529160000",
    "20220529180000",
    "20220529200000",
    "20220529220000",
    "20220530000000",
    "20220530020000",
    "20220530040000",
    "20220530060000",
    "20220530080000",
    "20220530100000",
    "20220530120000",
    "20220530140000",
    "20220530160000",
    "20220530180000",
    "20220530200000",
    "20220530220000",
    "20220531000000",
    "20220531020000",
    "20220531040000",
    "20220531060000",
    "20220531080000",
    "20220531100000",
    "20220531120000",
    "20220531140000",
    "20220531160000",
    "20220531180000",
    "20220531200000",
    "20220531220000",
    "20220601000000",
    "20220601020000",
    "20220601040000",
    "20220601060000",
    "20220601080000",
    "20220601100000",
    "20220601120000",
    "20220601140000",
    "20220601160000",
    "20220601180000",
    "20220601200000",
    "20220601220000",
    "20220602000000",
  ];
  const [index, setIndex] = useState(0);
  const [step, setStep] = useState(1);

  useEffect(() => {
    const interval = setInterval(() => {
      setStep(Math.max(1, 10 - varsState.domObjects.map.zoomLevel));
      setIndex((index + step) % urls.length);
      setUrl(baseUrl.replace("date", urls[index]));
    }, 1000);

    return () => {
      clearInterval(interval);
    };
  }, [url, index]);

  const handleClick = (e) => {
    console.log("click");
    setIndex(0);
  };

  function ResetButton() {
    return (
      <>
        <div className="reset-button">
          <Button onClick={handleClick} size="sm">
            {<span class={"reload"}>&#x21bb;</span>}
          </Button>
        </div>
      </>
    );
  }

  return (
    <>
      <div>
        {" "}
        {/* <FlexContainer> */}
        {/* add the main left menu */}
        <MainMenuControl settings={settings} position="leaflet-right" />
        {/* <SideNavBarMap /> */}
        {/* timeseries panel */}
        <PanelTabs position="leaflet-right" settings={settings} />
        <LayersControl>
          {/* adds base layer */}

          <BaseLayers baseLayerData={baseLayersData} />

          {/* adds layer of points as a react component */}
          {/* <PointsLayer layerName="Locations" consFixed={consFixed} /> */}

          {/* adds a polygon layer to the control and to the map as a component - boundaries */}
          <PolygonLayer
            layerData={consFixed["boundaries"]}
            layerName="Boundaries"
            reversePolygon
          />

          {/* adds GeoJson layer to the control and to the map as a component - river network */}
          {/* {settings.riverNetwork.fullRaw ? (
            <GeoJsonLayer layerSettings={settings.riverNetwork.fullRaw} />
          ) : (
            <></>
          )} */}

          <VectorGrid settings={settings} url={url} />
          <VectorGridLegend settings={settings} />
          <TimeViewer url={url} step={step} />
          <ResetButton></ResetButton>
          <ContourPolygon></ContourPolygon>
        </LayersControl>
        <SearchField />
        <ZoomControl position="bottomright" />
        <MapLegend settings={settings} position="left" />
      </div>
      {/* </FlexContainer> */}
    </>
  );
};

export default MapControler;
